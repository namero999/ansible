---
- name: Initial basic configuration for fresh machines

  hosts: to_provision

  tasks:

  # Generated by 'openssl passwd -salt datapine -1 <clear-text-pwd>'
  - name: Change root password
    user:
      name: root
      password: '{{ root_pwd_hash }}'

  - name: Setup hostname
    hostname:
      name: '{{ hostname }}'

  - name: Run a full upgrade
    yum:
      name: '*'
      state: latest

  - name: Base packages
    yum:
      name: net-tools,wget,curl,lsof,vim,ncdu,htop,bash-completion,zip,unzip,libaio,bc,flex

  - name: Install JDK
    unarchive:
      src: packages/jdk-7u79-linux-x64.tar.gz
      dest: /opt
      owner: root
      group: root
      creates: /opt/jdk1.7.0_79

  - name: Set JAVA_HOME
    lineinfile:
      dest: /etc/environment
      regexp: ^JAVA_HOME
      line:    JAVA_HOME="/opt/jdk1.7.0_79"

  - name: Disable useless services
    service:
      name: '{{ item }}'
      state: stopped
      enabled: no
    with_items:
      - postfix
      - avahi-daemon.service
      - avahi-daemon.socket

  - name: Uninstall useless services
    yum:
      name: '{{ item }}'
      state: absent
    with_items:
      - postfix
      - avahi
      - avahi-libs
      - avahi-autoipd

  - name: Set datapine user
    user:
      name: datapine

  - name: Set key for datapine user
    authorized_key:
      user: datapine
      key: '{{ lookup("file", "keys/provisioned.pub") }}'

  - name: Setup sshd
    lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: '{{ item.regexp }}'
      line:   '{{ item.line }}'
    with_items:
      - { regexp: '^#?Port',                   line: 'Port 9922' }
#      - { regexp: '^#?PermitRootLogin',        line: 'PermitRootLogin no' }
      - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
      - { regexp: '^#?LoginGraceTime',         line: 'LoginGraceTime 30' }
      - { regexp: '^#?AllowTcpForwarding',     line: 'AllowTcpForwarding no' }
      - { regexp: '^#?X11Forwarding',          line: 'X11Forwarding no' }
    notify:
      - restart sshd

  handlers:
  - name: restart sshd
    service:
      name: sshd
      state: restarted

---
- name: Initial basic configuration
  hosts: test

  tasks:
  - name: Run a full upgrade
    yum:
      name: '*'
      state: latest
#    command: yum -y upgrade

  - name: Setup hostname
    hostname:
      name: '{{ hostname }}'

  - name: Setup sshd
    lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: '{{ item.regexp }}'
      line:   '{{ item.line }}'
    with_items:
#      - { regexp: '^#?Port',                   line: 'Port 9922' }
      - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
      - { regexp: '^#?LoginGraceTime',         line: 'LoginGraceTime 30' }
      - { regexp: '^#?AllowTcpForwarding',     line: 'AllowTcpForwarding no' }
      - { regexp: '^#?X11Forwarding',          line: 'X11Forwarding no' }
    notify:
      - restart sshd

  - name: Set datapine user
    user:
      name: datapine
  
  - name: Base packages
    yum:
      name: net-tools,htop

  - name: Disable useless services
    service:
      name: '{{ item }}'
      state: stopped
      enabled: no
    with_items:
      - postfix
      - avahi-daemon.service
      - avahi-daemon.socket

  - name: Uninstall useless services
    yum:
      name: '{{ item }}'
      state: absent
    with_items:
      - postfix
      - avahi

  handlers:
  - name: restart sshd
    service:
      name: sshd
      state: restarted
